{% extends 'app/base_site.html' %}

{% block content %}

    <section class="content-header">
      <h1>
        Retail Billing
        <small>create bill for customer</small>
      </h1>
    </section>

    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-header">
              <h3 class="box-title">Data Table With Full Features</h3>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="dataTables_length">
                            <label>Total Items
                                <select name="total_items" id="total_items" onchange="createItemsTable()" aria-controls="example1" class="form-control input-sm">
                                <option value="0">0</option>
                                {% for r in range %}
                                    <option value="{{ r }}">{{ r }}</option>
                                {% endfor %}
                            </select></label>
                        </div>
                    </div>
                </div>
              <table class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th style='width:5px;'>#</th>
                  <th style='width:250px;'>Item</th>
                  <th style='width:20px;'>Quantity</th>
                  <th style='width:20px;'>MRP</th>
                  <th style='width:20px;'>Discount</th>
                  <th class='text-center' style='width:40px;'>Total</th>
                </tr>
                </thead>
                <tbody id="tbody">

                </tbody>
              </table>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
        <!-- /.col -->
        <div class="col-md-6 pull-right">
          <div class="box">
            <div class="box-header with-border">
              <h3 class="box-title">Grand Total</h3>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <table class="table table-bordered">
                <tr>
                  <th>Sub Total</th>
                  <th style="width: 100px;" class="text-center"><span id="sub_total"></span></th>
                </tr>
                <tr>
                  <th>Last Balance</th>
                  <th><input type="number" value=0 class="form-control" id="last_balance" onchange="calculateGrandTotal()"></th>
                </tr>
                <tr>
                  <th>Shipping Cost</th>
                  <th><input type="number" value=0 class="form-control" id="shipping_cost" onchange="calculateGrandTotal()"></th>
                </tr>
                <tr>
                  <th>Total Amount</th>
                  <th class="text-center"><span id="total_amount"></span></th>
                </tr>
                <tr>
                  <th>Amount Paid</th>
                  <th><input type="number" class="form-control" id="amount_paid" value="0" onchange="calculateGrandTotal()"></th>
                </tr>
                <tr>
                  <th>Remaining Balance</th>
                  <th class="text-center"><span id="remaining_balance"></span></th>
                </tr>
              </table>
            </div>
          </div>
        </div>
    </div>
      <!-- /.row -->

    </section>

    <script>
        function createItemsTable() {
            //$('#tbody').empty();
            let rowCount = parseInt($('#tbody tr').length);
            let items_count = $('#total_items').val();
            if(rowCount === 0){
                for(let i=1; i<=items_count; i++){
                    $('#tbody').append("<tr id='tr_item_"+i+"'>"+
                        "<td>"+i+"</td>"+
                        "<td><input class='form-control' type='text' id='item_name_"+i+"'></td>"+
                        "<td><input class='form-control' type='number' value=1 id='item_quantity_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td><input class='form-control' type='number' id='item_mrp_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td><input class='form-control' type='number' id='item_discount_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td class='text-center' style='padding-top:15px'><b><span id='item_total_"+i+"'></span></b></td>"+
                        "</tr>"
                    );
                }
            } else {
                for(let i=rowCount+1; i <= rowCount+parseInt(items_count); i++){
                    $('#tbody').append("<tr id='tr_item_"+i+"'>"+
                        "<td>"+i+"</td>"+
                        "<td><input class='form-control' type='text' id='item_name_"+i+"'></td>"+
                        "<td><input class='form-control' type='number' value=1 id='item_quantity_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td><input class='form-control' type='number' id='item_mrp_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td><input class='form-control' type='number' id='item_discount_"+i+"' value onchange='calculate_total(this.id)'></td>"+
                        "<td class='text-center' style='padding-top:15px'><b><span id='item_total_"+i+"'></span></b></td>"+
                        "</tr>"
                    );
                }
            }

        }
        function calculate_total(e){
            let res = e.split('_');

            let quantity = $('#item_quantity_'+res[2]).val();
            let mrp = $('#item_mrp_'+res[2]).val();
            let discount = $('#item_discount_'+res[2]).val();
            let total = (quantity * mrp) - ((quantity * mrp * discount) / 100);
            $('#item_total_'+res[2]).empty().append(total);

            let grand_total = 0;
            let items_count = parseInt($('#tbody tr').length);
            for(let i=1; i <= items_count; i++){
                let total = $('#item_total_'+i).text();
                if(total !== ''){
                    grand_total += parseInt(total)
                }
            }
            $('#sub_total').empty().append(grand_total);
            let total_amount = grand_total + parseInt($('#last_balance').val()) + parseInt($('#shipping_cost').val());
            $('#total_amount').empty().append(total_amount);
            let remaining_balance = total_amount - parseInt($('#amount_paid').val())
            $('#remaining_balance').empty().append(remaining_balance)
        }
        
        function calculateGrandTotal() {
            let sub_total = parseInt($('#sub_total').text());
            let total_amount = sub_total + parseInt($('#last_balance').val()) + parseInt($('#shipping_cost').val());
            $('#total_amount').empty().append(total_amount);
            let remaining_balance = total_amount - parseInt($('#amount_paid').val())
            $('#remaining_balance').empty().append(remaining_balance)
        }
    </script>
{% endblock %}